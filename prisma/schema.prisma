generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String             @id @default(cuid())
  email                String             @unique
  name                 String?
  password             String?
  photoUrl             String?
  role                 UserRole           @default(STUDENT)
  isPremium            Boolean            @default(false)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  subscriptionPlan     SubscriptionPlan   @default(FREE)
  stripeCustomerId     String?
  stripeSubscriptionId String?
  subscriptionStatus   SubscriptionStatus @default(ACTIVE)
  trialEndsAt          DateTime?
  subscriptionEndsAt   DateTime?
  subscriptionStartsAt DateTime?
  accounts             Account[]
  courses              Course[]
  progress             Progress[]
  sessions             Session[]
  studentProgress      StudentProgress[]
  userProgress         UserProgress[]

  @@map("users")
}

model Course {
  id              String            @id @default(cuid())
  title           String
  language        String            @default("Solidity")
  goals           String
  level           CourseLevel
  access          CourseAccess
  status          CourseStatus      @default(ACTIVE)
  thumbnail       String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  creatorId       String
  courseLanguages CourseLanguage[]
  courseProject   CourseProject?
  creator         User              @relation(fields: [creatorId], references: [id])
  modules         Module[]
  progress        Progress[]
  studentProgress StudentProgress[]
  userProgress    UserProgress[]

  @@map("courses")
}

model Module {
  id          String     @id @default(cuid())
  title       String
  description String
  order       Int
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  courseId    String
  lessons     Lesson[]
  course      Course     @relation(fields: [courseId], references: [id], onDelete: Cascade)
  progress    Progress[]

  @@map("modules")
}

model Lesson {
  id              String            @id @default(cuid())
  type            LessonType
  title           String
  contentMarkdown String?
  youtubeUrl      String?
  order           Int
  initialCode     String?
  solutionCode    String?
  tests           String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  moduleId        String
  challengeTests  ChallengeTest[]
  module          Module            @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  progress        Progress[]
  quizQuestions   QuizQuestion[]
  studentProgress StudentProgress[]
  userProgress    UserProgress[]

  @@map("lessons")
}

model QuizQuestion {
  id            String   @id @default(cuid())
  question      String
  options       String
  correctOption Int
  order         Int
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lessonId      String
  lesson        Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@map("quiz_questions")
}

model Progress {
  id        String   @id @default(cuid())
  completed Boolean  @default(false)
  quizScore Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  userId    String
  courseId  String
  moduleId  String
  lessonId  String
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  module    Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId, moduleId, lessonId])
  @@map("progress")
}

model UserProgress {
  id          String    @id @default(cuid())
  codeContent String?
  lastSavedAt DateTime?
  isCompleted Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  userId      String
  courseId    String
  lessonId    String
  course      Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lesson      Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId, lessonId])
  @@map("user_progress")
}

model ChallengeTest {
  id           String   @id @default(cuid())
  testContent  String
  testFileName String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  lessonId     String
  lesson       Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@map("challenge_tests")
}

model PasswordReset {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@map("password_resets")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Language {
  id              String                  @id @default(cuid())
  name            String                  @unique
  displayName     String
  compilerApp     String
  isActive        Boolean                 @default(false)
  icon            String?
  color           String?
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  courseLanguages CourseLanguage[]
  configurations  LanguageConfiguration[]

  @@map("languages")
}

model LanguageConfiguration {
  id           String   @id @default(cuid())
  compiler     String
  version      String
  buildCommand String?
  testCommand  String?
  lintCommand  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  languageId   String
  language     Language @relation(fields: [languageId], references: [id], onDelete: Cascade)

  @@unique([languageId, compiler])
  @@map("language_configurations")
}

model CourseLanguage {
  id         String   @id @default(cuid())
  isPrimary  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  courseId   String
  languageId String
  course     Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  language   Language @relation(fields: [languageId], references: [id], onDelete: Cascade)

  @@unique([courseId, languageId])
  @@map("course_languages")
}

model CourseProject {
  id            String             @id @default(cuid())
  projectPath   String
  foundryConfig Json?
  remappings    Json?
  isActive      Boolean            @default(true)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  courseId      String             @unique
  dependencies  CourseDependency[]
  course        Course             @relation(fields: [courseId], references: [id], onDelete: Cascade)
  templates     CourseTemplate[]

  @@map("course_projects")
}

model CourseDependency {
  id              String        @id @default(cuid())
  name            String
  version         String?
  source          String
  isInstalled     Boolean       @default(false)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  courseProjectId String
  courseProject   CourseProject @relation(fields: [courseProjectId], references: [id], onDelete: Cascade)

  @@unique([courseProjectId, name])
  @@map("course_dependencies")
}

model CourseTemplate {
  id              String        @id @default(cuid())
  name            String
  description     String?
  templatePath    String
  isDefault       Boolean       @default(false)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  courseProjectId String
  courseProject   CourseProject @relation(fields: [courseProjectId], references: [id], onDelete: Cascade)

  @@map("course_templates")
}

model StudentProgress {
  id                 String              @id @default(cuid())
  codeContent        String?
  lastSavedAt        DateTime?
  isCompleted        Boolean             @default(false)
  completedAt        DateTime?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  userId             String
  courseId           String
  lessonId           String
  compilationResults CompilationResult[]
  studentFiles       StudentFile[]
  course             Course              @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lesson             Lesson              @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  testResults        TestResult[]

  @@unique([userId, courseId, lessonId])
  @@map("student_progress")
}

model CompilationResult {
  id                String          @id @default(cuid())
  success           Boolean
  output            Json?
  errors            Json?
  warnings          Json?
  compilationTime   Int?
  createdAt         DateTime        @default(now())
  studentProgressId String
  studentProgress   StudentProgress @relation(fields: [studentProgressId], references: [id], onDelete: Cascade)

  @@map("compilation_results")
}

model TestResult {
  id                String          @id @default(cuid())
  success           Boolean
  output            Json?
  errors            Json?
  testCount         Int?
  passedCount       Int?
  failedCount       Int?
  testTime          Int?
  createdAt         DateTime        @default(now())
  studentProgressId String
  studentProgress   StudentProgress @relation(fields: [studentProgressId], references: [id], onDelete: Cascade)

  @@map("test_results")
}

model StudentFile {
  id                String          @id @default(cuid())
  fileName          String
  filePath          String
  content           String
  fileType          String
  isMain            Boolean         @default(false)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  studentProgressId String
  studentProgress   StudentProgress @relation(fields: [studentProgressId], references: [id], onDelete: Cascade)

  @@unique([studentProgressId, fileName])
  @@map("student_files")
}

enum UserRole {
  STUDENT
  ADMIN
}

enum CourseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum CourseAccess {
  FREE
  PAID
}

enum CourseStatus {
  ACTIVE
  DEACTIVATED
}

enum LessonType {
  INTRO
  QUIZ
  CHALLENGE
}

enum SubscriptionPlan {
  FREE
  MONTHLY
  YEARLY
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  CANCELED
  PAST_DUE
  TRIALING
}
